<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Shared Book Wishlist</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="https://unpkg.com/feather-icons"></script>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

<style>
  .book-card { transition: all 0.3s ease; }
  .book-card:hover { transform: translateY(-4px); box-shadow: 0 8px 18px -5px rgba(0,0,0,0.1); }
  .add-book-btn { transition: all 0.3s ease; }
  .add-book-btn:hover { transform: scale(1.05); }
  .dragging { opacity: 0.5; outline: 2px dashed rgba(79,70,229,0.75); transform: scale(0.98); }
  .drag-over { border: 2px dashed rgba(16,185,129,0.9); background-color: #ecfdf5; }
  .book-cover { aspect-ratio: 2 / 3; }
</style>
</head>
<body class="bg-gray-50 min-h-screen">

<div class="container mx-auto px-4 py-8">
  <header class="mb-10 text-center">
    <h1 class="text-3xl font-bold text-indigo-800 mb-1">Shared Book Wishlist</h1>
  </header>

  <div class="flex justify-center mb-6">
    <button onclick="openModal()" class="add-book-btn flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-full shadow-md text-sm">
      <i data-feather="plus" class="mr-2"></i> Add New Book
    </button>
  </div>

  <div id="books-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>

  <div id="empty-state" class="text-center py-20 hidden">
    <i data-feather="book-open" class="w-12 h-12 mx-auto text-gray-300 mb-3"></i>
    <h3 class="text-lg font-medium text-gray-500">No books yet</h3>
    <p class="text-gray-400 mt-1 text-sm">Add your first book to get started</p>
  </div>
</div>

<!-- Add/Edit Modal -->
<div id="add-book-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h3 id="modal-title" class="text-lg font-semibold">Add New Book</h3>
      <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700"><i data-feather="x"></i></button>
    </div>
    <form id="book-form" class="space-y-3 text-sm">
      <div>
        <label for="book-image" class="block font-medium mb-1">Book Cover</label>
        <input type="text" id="book-image" placeholder="Paste image URL" class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
      </div>
      <div>
        <label for="book-title" class="block font-medium mb-1">Title</label>
        <input type="text" id="book-title" required class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
      </div>
      <div>
        <label for="book-author" class="block font-medium mb-1">Author</label>
        <input type="text" id="book-author" required class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
      </div>
      <div>
        <label for="book-description" class="block font-medium mb-1">Description</label>
        <textarea id="book-description" rows="3" placeholder="Add a short description" class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
      </div>
      <div>
        <label for="book-url" class="block font-medium mb-1">Purchase URL (optional)</label>
        <input type="url" id="book-url" class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
      </div>
      <div class="pt-2">
        <button id="submit-btn" type="submit" class="w-full bg-indigo-600 text-white py-2 px-3 rounded-md hover:bg-indigo-700 transition duration-200">Add Book</button>
      </div>
    </form>
  </div>
</div>

<!-- Details Modal -->
<div id="details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-8 w-full max-w-4xl shadow-lg">
    <div class="flex flex-col md:flex-row gap-6">
      
      <!-- Book Cover -->
      <div class="w-full md:w-1/3">
        <img id="details-image" src="" alt="" class="rounded-md shadow w-full h-auto object-cover">
      </div>
      
      <!-- Title, Author, Buy Button -->
      <div class="flex flex-col justify-start w-full md:w-2/3">
        <div class="mb-4">
          <h3 id="details-title" class="text-2xl font-bold text-indigo-700 mb-1"></h3>
          <p id="details-author" class="text-gray-600 mb-3 text-sm"></p>
          <div id="details-link"></div>
        </div>
        <!-- Description below the title block -->
        <div>
          <h4 class="text-gray-800 font-semibold mb-2">Description</h4>
          <p id="details-description" class="text-gray-600 leading-relaxed"></p>
        </div>
      </div>

    </div>
    <button onclick="closeDetailsModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
      <i data-feather="x"></i>
    </button>
  </div>
</div>

<script>
AOS.init(); feather.replace();

// JSONBin.io configuration
const JSON_URL = "https://api.jsonbin.io/v3/b/68c0480043b1c97be93c9ab7/latest";
const JSON_WRITE_URL = "https://api.jsonbin.io/v3/b/68c0480043b1c97be93c9ab7";

let books = [];
let editingIndex = null;

const booksContainer = document.getElementById('books-container');
const emptyState = document.getElementById('empty-state');
const modal = document.getElementById('add-book-modal');
const bookForm = document.getElementById('book-form');
const modalTitle = document.getElementById('modal-title');
const submitBtn = document.getElementById('submit-btn');

const detailsModal = document.getElementById('details-modal');
const detailsTitle = document.getElementById('details-title');
const detailsAuthor = document.getElementById('details-author');
const detailsImage = document.getElementById('details-image');
const detailsDescription = document.getElementById('details-description');
const detailsLink = document.getElementById('details-link');

function escapeHtml(str){return str?String(str).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])):"";}

// Load books from JSONBin
async function loadBooks() {
  try {
    const res = await fetch(JSON_URL);
    const data = await res.json();
    books = data.record.books || [];
    displayBooks();
  } catch (e) { console.error("Failed to load books:", e); }
}

// Save books to JSONBin
async function saveBooks() {
  try {
    await fetch(JSON_WRITE_URL, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({books})
    });
  } catch (e) { console.error("Failed to save books:", e); }
}

// Display
function displayBooks() {
  booksContainer.innerHTML = '';
  if(!books.length){emptyState.classList.remove('hidden'); return;}
  emptyState.classList.add('hidden');

  books.forEach((book,i)=>{
    const card = document.createElement('div');
    card.className='book-card bg-white rounded-md overflow-hidden shadow-sm text-sm';
    card.setAttribute('data-index',i);
    card.setAttribute('draggable','true');
    card.addEventListener('dragstart', dragStart);
    card.addEventListener('dragover', dragOver);
    card.addEventListener('dragleave', dragLeave);
    card.addEventListener('drop', drop);
    card.addEventListener('dragend', dragEnd);

    const img = book.image || 'http://static.photos/books/320x480/'+(i+1);
    card.innerHTML=`
      <div class="book-cover cursor-pointer" onclick="openDetails(${i})">
        <img src="${img}" class="w-full h-full object-cover">
      </div>
      <div class="p-2">
        <h3 class="font-semibold truncate cursor-pointer" onclick="openDetails(${i})">${escapeHtml(book.title)}</h3>
        <p class="text-gray-600 text-xs mb-2">${escapeHtml(book.author)}</p>
        <div class="flex justify-between items-center">
          ${book.url?`<a href="${book.url}" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-xs flex items-center"><i data-feather="shopping-bag" class="w-3 h-3 mr-1"></i> Buy</a>`:'<span></span>'}
          <div class="flex space-x-2">
            <button onclick="editBook(${i})" class="text-blue-500 hover:text-blue-700 text-xs flex items-center"><i data-feather="edit-2" class="w-3 h-3 mr-1"></i>Edit</button>
            <button onclick="removeBook(${i})" class="text-red-500 hover:text-red-700 text-xs flex items-center"><i data-feather="trash-2" class="w-3 h-3 mr-1"></i>Del</button>
          </div>
        </div>
      </div>`;
    booksContainer.appendChild(card);
  });
  feather.replace();
}

// Drag & Drop
let draggedIndex=null;
function dragStart(e){draggedIndex=parseInt(e.currentTarget.dataset.index); e.currentTarget.classList.add('dragging');}
function dragOver(e){e.preventDefault(); e.currentTarget.classList.add('drag-over');}
function dragLeave(e){e.currentTarget.classList.remove('drag-over');}
async function drop(e){
  e.preventDefault();
  const target=parseInt(e.currentTarget.dataset.index);
  if(draggedIndex===target) return;
  const moved=books.splice(draggedIndex,1)[0];
  books.splice(target,0,moved);
  await saveBooks();
  displayBooks();
}
function dragEnd(){document.querySelectorAll('.book-card').forEach(c=>c.classList.remove('dragging','drag-over'));}

// Add/Edit
bookForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const b={
    title:bookForm.querySelector('#book-title').value,
    author:bookForm.querySelector('#book-author').value,
    description:bookForm.querySelector('#book-description').value,
    image:bookForm.querySelector('#book-image').value,
    url:bookForm.querySelector('#book-url').value
  };
  if(editingIndex!==null){books[editingIndex]=b; editingIndex=null;} else {books.push(b);}
  await saveBooks();
  closeModal();
  displayBooks();
  bookForm.reset();
});

function removeBook(i){books.splice(i,1); saveBooks().then(displayBooks);}
function editBook(i){
  const b=books[i];
  bookForm.querySelector('#book-title').value=b.title;
  bookForm.querySelector('#book-author').value=b.author;
  bookForm.querySelector('#book-description').value=b.description;
  bookForm.querySelector('#book-image').value=b.image;
  bookForm.querySelector('#book-url').value=b.url;
  modalTitle.textContent='Edit Book';
  submitBtn.textContent='Update';
  editingIndex=i;
  openModal();
}

// Details modal
function openDetails(i){
  const b=books[i];
  detailsTitle.textContent=b.title;
  detailsAuthor.textContent=b.author?'by '+b.author:'';
  detailsDescription.textContent=b.description||'No description provided.';
  detailsImage.src=b.image||'http://static.photos/books/320x480/'+(i+1);
  detailsLink.innerHTML=b.url?`<a href="${b.url}" target="_blank" class="inline-flex items-center px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm"><i data-feather="shopping-bag" class="w-4 h-4 mr-2"></i>Buy this book</a>`:`<p class="text-gray-400 text-sm">No purchase link</p>`;
  detailsModal.classList.remove('hidden');
  feather.replace();
}
function closeDetailsModal(){detailsModal.classList.add('hidden');}

function openModal(){modal.classList.remove('hidden');}
function closeModal(){modal.classList.add('hidden'); modalTitle.textContent='Add New Book'; submitBtn.textContent='Add Book'; bookForm.reset(); editingIndex=null;}

// Real-time updates every 5 seconds
setInterval(loadBooks, 5000);

loadBooks();
</script>
</body>
</html>
